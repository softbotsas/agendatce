<!-- Historial de Actividades -->
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="mb-0">
          <i class="fas fa-history text-primary me-2"></i>
          Historial de Actividades
        </h4>
        <div>
          <button class="btn btn-outline-primary me-2" onclick="refreshHistory()">
            <i class="fas fa-sync-alt me-1"></i>
            Actualizar
          </button>
          <button class="btn btn-outline-success" onclick="exportHistory()">
            <i class="fas fa-download me-1"></i>
            Exportar
          </button>
        </div>
      </div>

      <!-- Filtros Avanzados -->
      <div class="card mb-4">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
              <i class="fas fa-filter me-2"></i>
              Filtros Avanzados
            </h6>
            <button class="btn btn-sm btn-outline-secondary" onclick="toggleAdvancedFilters()">
              <i class="fas fa-cog me-1"></i>
              Configurar
            </button>
          </div>
        </div>
        <div class="card-body" id="filters-section">
          <div class="row g-3">
            <!-- Departamento -->
            <div class="col-md-3">
              <label class="form-label">Departamento</label>
              <select class="form-select" id="department-filter" onchange="onDepartmentChange()">
                <option value="">Todos los departamentos</option>
              </select>
            </div>
            
            <!-- Usuario -->
            <div class="col-md-3">
              <label class="form-label">Usuario</label>
              <select class="form-select" id="user-filter">
                <option value="">Todos los usuarios</option>
              </select>
            </div>
            
            <!-- Tarea -->
            <div class="col-md-3">
              <label class="form-label">Tarea</label>
              <select class="form-select" id="task-filter">
                <option value="">Todas las tareas</option>
              </select>
            </div>
            
            <!-- Tipo de Acci√≥n -->
            <div class="col-md-3">
              <label class="form-label">Tipo de Acci√≥n</label>
              <select class="form-select" id="action-filter">
                <option value="">Todas las acciones</option>
                <option value="completed">Completadas</option>
                <option value="increment">Incrementadas</option>
                <option value="not_applicable">No Aplica</option>
              </select>
            </div>
            
            <!-- Estado -->
            <div class="col-md-3">
              <label class="form-label">Estado</label>
              <select class="form-select" id="status-filter">
                <option value="">Todos los estados</option>
                <option value="completed">Completadas</option>
                <option value="overdue">Atrasadas</option>
                <option value="with_evidence">Con evidencia</option>
                <option value="without_evidence">Sin evidencia</option>
              </select>
            </div>
            
            <!-- Rango de Fechas -->
            <div class="col-md-3">
              <label class="form-label">Desde</label>
              <input type="date" class="form-control" id="date-from">
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Hasta</label>
              <input type="date" class="form-control" id="date-to">
            </div>
            
            <!-- Botones de Acci√≥n -->
            <div class="col-md-3 d-flex align-items-end">
              <div class="btn-group w-100">
                <button class="btn btn-primary" onclick="applyFilters()">
                  <i class="fas fa-search me-1"></i>
                  Filtrar
                </button>
                <button class="btn btn-outline-secondary" onclick="clearFilters()">
                  <i class="fas fa-times me-1"></i>
                  Limpiar
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Estad√≠sticas -->
      <div class="row mb-4" id="history-stats">
        <div class="col-md-2">
          <div class="card text-center bg-primary text-white">
            <div class="card-body">
              <h5 class="card-title" id="total-activities">0</h5>
              <p class="card-text">Total Actividades</p>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card text-center bg-success text-white">
            <div class="card-body">
              <h5 class="card-title" id="completed-count">0</h5>
              <p class="card-text">Completadas</p>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card text-center bg-info text-white">
            <div class="card-body">
              <h5 class="card-title" id="increment-count">0</h5>
              <p class="card-text">Incrementadas</p>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card text-center bg-warning text-white">
            <div class="card-body">
              <h5 class="card-title" id="overdue-count">0</h5>
              <p class="card-text">Atrasadas</p>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card text-center bg-secondary text-white">
            <div class="card-body">
              <h5 class="card-title" id="not-applicable-count">0</h5>
              <p class="card-text">No Aplica</p>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card text-center bg-dark text-white">
            <div class="card-body">
              <h5 class="card-title" id="active-users">0</h5>
              <p class="card-text">Usuarios Activos</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Lista de Actividades -->
      <div id="history-container">
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando historial...</span>
          </div>
          <p class="mt-3 text-muted">Cargando historial de actividades...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para detalles de actividad -->
<div class="modal fade" id="activityDetailModal" tabindex="-1" aria-labelledby="activityDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="activityDetailModalLabel">Detalles de la Actividad</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Contenido din√°mico -->
      </div>
    </div>
  </div>
</div>

<!-- Modal para evidencias -->
<div class="modal fade" id="evidenceModal" tabindex="-1" aria-labelledby="evidenceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="evidenceModalLabel">Evidencia</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <!-- Contenido din√°mico -->
      </div>
    </div>
  </div>
</div>

<script>
// Variables globales para el historial
let historyData = [];
let filteredHistory = [];
let departments = [];
let users = [];
let tasks = [];

// ========================================
// FUNCIONES PRINCIPALES DEL HISTORIAL
// ========================================

// Cargar datos del historial desde el servidor
async function loadHistoryData() {
  console.log('üöÄ Cargando historial desde servidor...');
  
  const container = document.getElementById('history-container');
  if (!container) {
    console.error('‚ùå Container history-container no encontrado');
    return;
  }
  
  try {
    const response = await fetch('/agenda/api/history/all', {
      credentials: 'include'
    });
    
    console.log('üì° Respuesta del servidor:', response.status);
    
    if (!response.ok) {
      throw new Error(`Error ${response.status}: ${response.statusText}`);
    }
    
    const result = await response.json();
    console.log('üìä Datos recibidos:', result);
    
    if (result.success && result.data) {
      historyData = result.data;
      filteredHistory = [...historyData];
      
      console.log('‚úÖ Historial cargado:', historyData.length, 'actividades');
      
      // Actualizar estad√≠sticas
      updateHistoryStats(historyData);
      
      // Mostrar historial
      updateHistoryDisplay(filteredHistory);
      
      // Cargar datos para filtros
      await loadFilterData();
      
    } else {
      throw new Error(result.message || 'Error desconocido del servidor');
    }
    
  } catch (error) {
    console.error('‚ùå Error cargando historial:', error);
    showHistoryError('Error al cargar el historial: ' + error.message);
  }
}

// Cargar datos para los filtros
async function loadFilterData() {
  console.log('üîß Cargando datos para filtros...');
  
  try {
    // Cargar departamentos
    const deptResponse = await fetch('/agenda/api/configuration/departments', {
      credentials: 'include'
    });
    if (deptResponse.ok) {
      const deptResult = await deptResponse.json();
      departments = deptResult.data || [];
      populateDepartmentFilter();
    }
    
    // Cargar usuarios
    const userResponse = await fetch('/agenda/api/configuration/employees', {
      credentials: 'include'
    });
    if (userResponse.ok) {
      const userResult = await userResponse.json();
      users = userResult.data || [];
      populateUserFilter();
    }
    
    // Cargar tareas
    const taskResponse = await fetch('/agenda/api/configuration/tasks', {
      credentials: 'include'
    });
    if (taskResponse.ok) {
      const taskResult = await taskResponse.json();
      tasks = taskResult.data || [];
      populateTaskFilter();
    }
    
    console.log('‚úÖ Datos de filtros cargados');
    
  } catch (error) {
    console.error('‚ùå Error cargando datos de filtros:', error);
  }
}

// ========================================
// FUNCIONES DE FILTROS
// ========================================

function populateDepartmentFilter() {
  const select = document.getElementById('department-filter');
  if (!select) return;
  
  select.innerHTML = '<option value="">Todos los departamentos</option>';
  departments.forEach(dept => {
    const option = document.createElement('option');
    option.value = dept._id;
    option.textContent = dept.name || dept.departamento_name || 'Sin nombre';
    select.appendChild(option);
  });
}

function populateUserFilter() {
  const select = document.getElementById('user-filter');
  if (!select) return;
  
  select.innerHTML = '<option value="">Todos los usuarios</option>';
  users.forEach(user => {
    const option = document.createElement('option');
    option.value = user._id;
    option.textContent = user.name || user.nombre || 'Usuario sin nombre';
    select.appendChild(option);
  });
}

function populateTaskFilter() {
  const select = document.getElementById('task-filter');
  if (!select) return;
  
  select.innerHTML = '<option value="">Todas las tareas</option>';
  tasks.forEach(task => {
    const option = document.createElement('option');
    option.value = task._id;
    option.textContent = task.title || 'Tarea sin t√≠tulo';
    select.appendChild(option);
  });
}

function onDepartmentChange() {
  const departmentSelect = document.getElementById('department-filter');
  const userSelect = document.getElementById('user-filter');
  
  if (!departmentSelect || !userSelect) return;
  
  const selectedDept = departmentSelect.value;
  
  // Filtrar usuarios por departamento
  userSelect.innerHTML = '<option value="">Todos los usuarios</option>';
  
  const filteredUsers = selectedDept ? 
    users.filter(user => user.departamento === selectedDept) : 
    users;
    
  filteredUsers.forEach(user => {
    const option = document.createElement('option');
    option.value = user._id;
    option.textContent = user.name || user.nombre || 'Usuario sin nombre';
    userSelect.appendChild(option);
  });
}

function applyFilters() {
  console.log('üîç Aplicando filtros...');
  
  const departmentFilter = document.getElementById('department-filter')?.value || '';
  const userFilter = document.getElementById('user-filter')?.value || '';
  const taskFilter = document.getElementById('task-filter')?.value || '';
  const actionFilter = document.getElementById('action-filter')?.value || '';
  const statusFilter = document.getElementById('status-filter')?.value || '';
  const dateFrom = document.getElementById('date-from')?.value || '';
  const dateTo = document.getElementById('date-to')?.value || '';
  
  console.log('üéØ Filtros aplicados:', {
    departmentFilter, userFilter, taskFilter, 
    actionFilter, statusFilter, dateFrom, dateTo
  });
  
  filteredHistory = historyData.filter(activity => {
    // Filtro por departamento (a trav√©s del usuario)
    if (departmentFilter) {
      const user = users.find(u => u._id === activity.user_id);
      if (!user || user.departamento !== departmentFilter) {
        return false;
      }
    }
    
    // Filtro por usuario
    if (userFilter && activity.user_id !== userFilter) {
      return false;
    }
    
    // Filtro por tarea
    if (taskFilter && activity.task_definition !== taskFilter) {
      return false;
    }
    
    // Filtro por tipo de acci√≥n
    if (actionFilter && activity.action_type !== actionFilter) {
      return false;
    }
    
    // Filtro por estado
    if (statusFilter) {
      if (statusFilter === 'with_evidence' && (!activity.evidence || activity.evidence.length === 0)) {
        return false;
      }
      if (statusFilter === 'without_evidence' && activity.evidence && activity.evidence.length > 0) {
        return false;
      }
    }
    
    // Filtro por rango de fechas
    if (dateFrom || dateTo) {
      const activityDate = new Date(activity.created_at);
      if (dateFrom && activityDate < new Date(dateFrom)) {
        return false;
      }
      if (dateTo && activityDate > new Date(dateTo + 'T23:59:59')) {
        return false;
      }
    }
    
    return true;
  });
  
  console.log('üìä Resultado filtrado:', filteredHistory.length, 'actividades');
  
  // Actualizar estad√≠sticas con datos filtrados
  updateHistoryStats(filteredHistory);
  
  // Mostrar historial filtrado
  updateHistoryDisplay(filteredHistory);
}

function clearFilters() {
  console.log('üßπ Limpiando filtros...');
  
  // Resetear todos los filtros
  document.getElementById('department-filter').value = '';
  document.getElementById('user-filter').value = '';
  document.getElementById('task-filter').value = '';
  document.getElementById('action-filter').value = '';
  document.getElementById('status-filter').value = '';
  document.getElementById('date-from').value = '';
  document.getElementById('date-to').value = '';
  
  // Restaurar historial completo
  filteredHistory = [...historyData];
  
  // Actualizar estad√≠sticas
  updateHistoryStats(filteredHistory);
  
  // Mostrar historial completo
  updateHistoryDisplay(filteredHistory);
}

function toggleAdvancedFilters() {
  const filtersSection = document.getElementById('filters-section');
  if (filtersSection.style.display === 'none') {
    filtersSection.style.display = 'block';
  } else {
    filtersSection.style.display = 'none';
  }
}

// ========================================
// FUNCIONES DE ESTAD√çSTICAS
// ========================================

function updateHistoryStats(activities) {
  console.log('üìä Actualizando estad√≠sticas...');
  
  const totalActivities = activities.length;
  const completedCount = activities.filter(a => a.action_type === 'completed').length;
  const incrementCount = activities.filter(a => a.action_type === 'increment').length;
  const notApplicableCount = activities.filter(a => a.action_type === 'not_applicable').length;
  
  // Contar usuarios √∫nicos
  const uniqueUsers = new Set(activities.map(a => a.user_id)).size;
  
  // Actualizar DOM - verificar que los elementos existan
  const totalEl = document.getElementById('total-activities');
  const completedEl = document.getElementById('completed-count');
  const incrementEl = document.getElementById('increment-count');
  const notApplicableEl = document.getElementById('not-applicable-count');
  const activeUsersEl = document.getElementById('active-users');
  const overdueEl = document.getElementById('overdue-count');
  
  if (totalEl) totalEl.textContent = totalActivities;
  if (completedEl) completedEl.textContent = completedCount;
  if (incrementEl) incrementEl.textContent = incrementCount;
  if (notApplicableEl) notApplicableEl.textContent = notApplicableCount;
  if (activeUsersEl) activeUsersEl.textContent = uniqueUsers;
  if (overdueEl) overdueEl.textContent = '0';
  
  console.log('‚úÖ Estad√≠sticas actualizadas');
}

// ========================================
// FUNCIONES DE VISUALIZACI√ìN
// ========================================

function updateHistoryDisplay(activities) {
  console.log('üé® Actualizando visualizaci√≥n...');
  
  const container = document.getElementById('history-container');
  if (!container) {
    console.error('‚ùå Container history-container no encontrado');
    return;
  }
  
  if (!activities || activities.length === 0) {
    container.innerHTML = `
      <div class="text-center py-5">
        <i class="fas fa-history text-muted fa-3x mb-3"></i>
        <h5>No hay actividades que coincidan con los filtros</h5>
        <p class="text-muted">Intenta ajustar los filtros o registrar nuevas actividades.</p>
      </div>
    `;
    return;
  }
  
  // Agrupar por fecha
  const groupedActivities = {};
  activities.forEach(activity => {
    const date = new Date(activity.created_at).toLocaleDateString('es-ES');
    if (!groupedActivities[date]) {
      groupedActivities[date] = [];
    }
    groupedActivities[date].push(activity);
  });
  
  let html = '';
  
  Object.keys(groupedActivities).sort((a, b) => new Date(b) - new Date(a)).forEach(date => {
    const dayActivities = groupedActivities[date];
    
    html += `
      <div class="mb-4">
        <h6 class="text-primary mb-3">
          <i class="fas fa-calendar-day me-2"></i>
          ${date} (${dayActivities.length} actividades)
        </h6>
        <div class="timeline">
          ${dayActivities.map(activity => createActivityCard(activity)).join('')}
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  console.log('‚úÖ Visualizaci√≥n actualizada');
}

function createActivityCard(activity) {
  const actionIcon = {
    'completed': 'check-circle',
    'increment': 'plus-circle',
    'not_applicable': 'ban'
  }[activity.action_type] || 'circle';
  
  const actionColor = {
    'completed': 'success',
    'increment': 'info',
    'not_applicable': 'secondary'
  }[activity.action_type] || 'primary';
  
  const actionText = {
    'completed': 'Complet√≥',
    'increment': 'Increment√≥',
    'not_applicable': 'Marc√≥ como No Aplica'
  }[activity.action_type] || 'Registr√≥ acci√≥n';
  
  const evidenceBadges = activity.evidence && activity.evidence.length > 0 ? 
    activity.evidence.map(ev => `
      <span class="badge bg-warning me-1" onclick="viewEvidence('${ev.url}', '${ev.original_name || ev.filename}')" style="cursor: pointer;">
        <i class="fas fa-paperclip me-1"></i>${ev.original_name || ev.filename}
      </span>
    `).join('') : '';
  
  return `
    <div class="card mb-3 border-0 shadow-sm">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-md-1">
            <div class="bg-${actionColor} bg-opacity-10 rounded-3 p-2 text-center">
              <i class="fas fa-${actionIcon} text-${actionColor}"></i>
            </div>
          </div>
          <div class="col-md-3">
            <h6 class="mb-1">${activity.task_title || 'Tarea sin t√≠tulo'}</h6>
            <p class="text-muted mb-0 small">
              <i class="fas fa-user me-1"></i>${activity.user_name || 'Usuario desconocido'}
            </p>
          </div>
          <div class="col-md-2">
            <span class="badge bg-${actionColor}">${actionText}</span>
            ${activity.action_type === 'increment' ? `<br><small class="text-muted">Valor: +${activity.value}</small>` : ''}
          </div>
          <div class="col-md-3">
            <small class="text-muted">${new Date(activity.created_at).toLocaleTimeString('es-ES')}</small>
            ${evidenceBadges ? `<br>${evidenceBadges}` : ''}
          </div>
          <div class="col-md-3">
            ${activity.comment ? 
              `<div class="text-truncate" title="${activity.comment}">
                <i class="fas fa-comment me-1"></i>
                <small class="text-muted">${activity.comment.substring(0, 40)}${activity.comment.length > 40 ? '...' : ''}</small>
              </div>` : ''}
            <button class="btn btn-sm btn-outline-primary mt-1" onclick="viewActivityDetails('${activity._id}')">
              <i class="fas fa-eye me-1"></i>Ver detalles
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
}

// ========================================
// FUNCIONES DE MODALES
// ========================================

function viewActivityDetails(activityId) {
  const activity = historyData.find(a => a._id === activityId);
  if (!activity) return;
  
  const modal = new bootstrap.Modal(document.getElementById('activityDetailModal'));
  const modalBody = document.querySelector('#activityDetailModal .modal-body');
  
  modalBody.innerHTML = `
    <div class="row">
      <div class="col-md-6">
        <h6>Informaci√≥n General</h6>
        <p><strong>Tarea:</strong> ${activity.task_title || 'Sin t√≠tulo'}</p>
        <p><strong>Usuario:</strong> ${activity.user_name || 'Desconocido'}</p>
        <p><strong>Acci√≥n:</strong> ${getActionText(activity.action_type)}</p>
        <p><strong>Fecha:</strong> ${new Date(activity.created_at).toLocaleString('es-ES')}</p>
      </div>
      <div class="col-md-6">
        <h6>Comentarios</h6>
        <p>${activity.comment || 'Sin comentarios'}</p>
        ${activity.evidence && activity.evidence.length > 0 ? `
          <h6>Evidencias</h6>
          ${activity.evidence.map(ev => `
            <button class="btn btn-sm btn-outline-primary me-2 mb-2" onclick="viewEvidence('${ev.url}', '${ev.original_name || ev.filename}')">
              <i class="fas fa-paperclip me-1"></i>${ev.original_name || ev.filename}
            </button>
          `).join('')}
        ` : ''}
      </div>
    </div>
  `;
  
  modal.show();
}

function viewEvidence(url, filename) {
  if (!url || !filename) return;
  
  const modal = new bootstrap.Modal(document.getElementById('evidenceModal'));
  const modalBody = document.querySelector('#evidenceModal .modal-body');
  const modalTitle = document.querySelector('#evidenceModal .modal-title');
  
  modalTitle.textContent = filename;
  
  modalBody.innerHTML = isImageFile(filename) ? 
    `<img src="${url}" class="img-fluid" alt="${filename}">` :
    `<div class="alert alert-info">
      <i class="fas fa-file me-2"></i>
      Archivo: ${filename}
      <br><br>
      <a href="${url}" class="btn btn-primary" download="${filename}">
        <i class="fas fa-download me-1"></i>Descargar archivo
      </a>
    </div>`;
  
  modal.show();
}

// ========================================
// FUNCIONES AUXILIARES
// ========================================

function getActionText(actionType) {
  const actions = {
    'completed': 'Complet√≥',
    'increment': 'Increment√≥',
    'not_applicable': 'Marc√≥ como No Aplica'
  };
  return actions[actionType] || 'Registr√≥ acci√≥n';
}

function isImageFile(filename) {
  const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
  const ext = filename.toLowerCase().substring(filename.lastIndexOf('.'));
  return imageExtensions.includes(ext);
}

function showHistoryError(message) {
  const container = document.getElementById('history-container');
  if (container) {
    container.innerHTML = `
      <div class="alert alert-danger text-center">
        <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
        <h5>Error al cargar el historial</h5>
        <p>${message}</p>
        <button class="btn btn-primary" onclick="loadHistoryData()">
          <i class="fas fa-refresh me-1"></i>Reintentar
        </button>
      </div>
    `;
  }
}

function refreshHistory() {
  loadHistoryData();
}

function exportHistory() {
  alert('Funcionalidad de exportaci√≥n en desarrollo');
}

// ========================================
// INICIALIZACI√ìN
// ========================================

// Funci√≥n de inicializaci√≥n que se puede llamar desde cualquier lugar
function initializeHistory() {
  console.log('üöÄ Inicializando historial...');
  loadHistoryData();
}

// Event listener para cuando se carga la p√°gina normalmente
document.addEventListener('DOMContentLoaded', function() {
  console.log('üöÄ Historial inicializado via DOMContentLoaded');
  initializeHistory();
});

// Hacer funciones globales para compatibilidad
window.loadHistoryData = loadHistoryData;
window.initializeHistory = initializeHistory;
window.applyFilters = applyFilters;
window.clearFilters = clearFilters;
window.viewActivityDetails = viewActivityDetails;
window.viewEvidence = viewEvidence;
window.toggleAdvancedFilters = toggleAdvancedFilters;
window.onDepartmentChange = onDepartmentChange;
window.refreshHistory = refreshHistory;
window.exportHistory = exportHistory;

// Auto-inicializar si se ejecuta directamente
if (document.readyState === 'loading') {
  // El DOM a√∫n se est√° cargando
  document.addEventListener('DOMContentLoaded', initializeHistory);
} else {
  // El DOM ya est√° listo
  console.log('üöÄ DOM ya listo, inicializando inmediatamente');
  setTimeout(initializeHistory, 100);
}
</script>